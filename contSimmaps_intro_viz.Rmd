---
title: "simBM_vignette"
author: "Bruce Martin"
date: "11/6/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

First, let's simulate some data to reconstruct continuous stochastic character maps (contSimmaps) from. For this, we need a phylogenetic tree and a vector of continuously-valued traits we're interested in.

```{r}
library(contSimmap)
library(phytools)
set.seed(123)
#simulate a random tree
tree<-pbtree(n=50)
#simulate the evolution of continuous trait under a Brownian Motion model
x_complete<-fastBM(tree,internal=T)
```

With this tree and a vector of trait values corresponding to its tips, we can simulate contSimmaps using a single function.

```{r}
#limit vector of trait values to just those observed at the tips of the phylogeny
x<-x_complete[1:length(tree$tip.label)]
#generate a contSimmap object from the simulated tree and vector of trait values
sim<-simBM(tree=tree,x=x,n.sim=100)
```

We can easily visualize the output of this function using the plot function, further specifying how many individual simulations we want to plot and what color/how transparent we want them to be. As a bonus, since the true history of our trait of interest is known in this case, we may plot the true history over top these simulations and see how they match up. For this, I will use the contSimmaps function fastpgram(); if you're familiar with the phenogram() function in Liam Revell's package phytools, this is just a water-down version of the same thing. Also, don't be scared by the alter.cols() function--it is a simple function from contSimmaps that is helpful for modifying the shade and transparency of a vector of colors on the fly. In this case, I am just using it to make node points (plotted by default in the fastpgram() function) completely transparent.

```{r}
#plot simulations
plot(sim,tree,n.sample=50,alph=0.2,col='gray')
#plot true history
fastpgram(x_complete,tree,add=T,node.col=alter.cols('black',alph=0))
```

That's cool, but with so many simulations it often becomes unclear which edges correspond to one another across different simulations (and the true history). To this end, contSimmaps includes a number of color mapping (colmap) functions that allow us to easily create and modify vectors of colors mapped to each edge of a phylogeny. For now, I will use the function evolve.colors() to generate a colmap, which simulates the evolution of a phylogeny in a color space.

```{r}
#generate colmap
colmap<-evolve.colors(tree)
#plot simulations--now in color!
plot(sim,tree,n.sample=50,alph=0.2,col=alter.cols(colmap,mod.val=0.1))
#plot true history--now also in color!
fastpgram(x_complete,tree,add=T,node.col=alter.cols('black',0),edge.col=colmap,lwd=2)
```

That helps a bit, but, as you can see, there's just too many nodes and tips to get a good idea of what's going on in the 'central' part of trait space. See the color function vignette to learn more about how to generate and modify colmaps to enhance your visualizations of contSimmaps. For now, I will demonstrate another strategy for 'visual clarity': simplifying the contSimmaps to consist of 'pseudosimulations' that correspond to the quantiles of the real simulations.
  Note here I am also using an alternative method for sampling from the simulations in the plot() function--'choose'. Using this parameter, you can pick specific simulations you want to plot. This is helpful in our case because each of the 'pseudosimulations' in the simplified contSimmaps object correspond to specfic quantiles we're interested in for different reasons. In this case, I will plot the 50% quantile separately from the 10% and 90% quantiles so I can make the lines in different styles and visualize a sort of 'confidence interval' around the mean simulation values.

```{r}
#simplify contSimmaps to consist of three 'pseudosimulations': the 10%, 50% (mean/median), and 90% quantiles
sim_simplified<-simplify.sim(sim,probs=c(0.1,0.5,0.9))
#plot mean simulation values
plot(sim_simplified,tree,choose=2,col=alter.cols(colmap,mod.val=0.1))
#plot 10% and 90% simulation values to see 'confidence intervals'
plot(sim_simplified,tree,choose=c(1,3),col=alter.cols(colmap,mod.val=0.2),lty=2,add=T)
#plot true history
fastpgram(x_complete,tree,add=T,node.col=alter.cols('black',0),edge.col=alter.cols(colmap,0.3),lwd=4)
```

Now we're getting somewhere! But this isn't the end to all of the possibilities--I purposefully designed the plotting method for contSimmaps to be fairly flexible (at the cost of the complexity of internal function, which might be greater than some folks would otherwise want). Anyways, some other helpful things to know is that, by setting arguments pts and/or polyg to TRUE, plot() will instead plot the contSimmap object as a series of points and/or polygons, respectively. You can also set the arguments lines equal to FALSE (it is TRUE by default) to prevent plot() from plotting any lines whatsoever. In general, other graphical arguments you may be familiar with, like lwd, lty, pch, cex, and border should all work for their corresponding plot elements, though the function is currently limited to applying the same arguments to all simulations plotted (and lwd and lty arguments will apply to BOTH polygon and lines plotting). This quirk might be fixed in future updates.

```{r}
#pretty tree with 'shaded confidence intervals'
plot(sim_simplified,tree,choose=c(1,3),col=alter.cols(colmap,mod.val=0.2),alph=0.1,lines=F,polyg=T)
plot(sim_simplified,tree,choose=2,col=alter.cols(colmap,mod.val=0.1),add=T)
fastpgram(x_complete,tree,add=T,node.col=alter.cols('black',0),edge.col=alter.cols(colmap,0.3),lwd=4)
#you can also zoom in on certain parts
plot(sim_simplified,tree,choose=c(1,3),col=alter.cols(colmap,mod.val=0.2),alph=0.1,polyg=T,xlim=c(2,3),ylim=c(-2,2))
plot(sim_simplified,tree,choose=2,col=alter.cols(colmap,mod.val=0.1),add=T)
fastpgram(x_complete,tree,add=T,node.col=alter.cols('black',0),edge.col=alter.cols(colmap,0.3),lwd=4)
#if you're only interested in node values, that's also doable
sim_nodesonly<-sim_simplified;sim_nodesonly$edges<-NULL
plot(sim_nodesonly,tree,choose=2,col=alter.cols(colmap,0.4,mod.val=0.1),lines=F,pts=T,cex=2)
plot(sim_nodesonly,tree,choose=c(1,3),col=alter.cols(colmap,0.4,mod.val=0.2),lines=F,pts=T,pch=18,cex=2,add=T)
#get.node.colmap is a helpful function that gets a nodewise colmap from an edgewise one by averaging colors across adjacent edges
#this is handled internally plotting method for simBM, but not for fastpgram()
fastpgram(x_complete,tree,add=T,node.col=alter.cols(get.node.colmap(colmap,tree),0.8),edge.col=alter.cols(colmap,0),pch=16,lwd=4)
```

As is made plainly clear by this, Brownian motion is a very stochastic, noisy process, and rarely conforms to our max likelihood expectations (which the contSimmap function is based on). Nonetheless, in absence of other sources of information (fossils,etc.) max likelihood estimates are just about are best guesses regarding ancrestral traits. At the very least, contSimmaps allows you to explore the estimability of ancestral state reconstruction over both the nodes and edges of a phylogeny, rather than simply rely on a single point estimate at the nodes.